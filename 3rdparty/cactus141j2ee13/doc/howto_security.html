<HTML><HEAD><TITLE>Testing secure code Howto</TITLE></HEAD><BODY alink="#023264" bgcolor="#ffffff" leftmargin="4" link="#525D76" marginheight="4" marginwidth="4" text="#000000" topmargin="4" vlink="#023264"><TABLE border="0" cellpadding="0" cellspacing="0" width="100%"><TR><TD align="left" valign="top"><A href="http://jakarta.apache.org/index.html"><IMG border="0" hspace="0" src="./images/jakarta-logo.gif" vspace="0"></A></TD><TD align="left" bgcolor="#ffffff" valign="middle" width="100%"><IMG align="right" alt="Testing secure code Howto" border="0" hspace="0" src=".//images/logocactus.gif" vspace="0"></TD></TR><TR><TD colspan="2" height="2" width="100%"><HR noshade="" size="1"></TD></TR></TABLE><TABLE border="0" cellpadding="0" cellspacing="0" width="100%"><TR><TD valign="top" width="1%"></TD><TD nowrap="1" valign="top" width="14%"><FONT size="-2">
              Last update : August 31 2002</FONT><BR><FONT size="-2">
              Doc for : v1.4.1</FONT><BR><FONT face="arial,helvetica,sanserif">

  <BR><FONT color="#000000" size="+1">About</FONT><BR><FONT size="-1">
    <LI><A href="./index.html"><FONT size="-1">What is Cactus ?</FONT></A></LI>
    <LI><A href="./news.html"><FONT size="-1">News</FONT></A></LI>
    <LI><A href="./changes.html"><FONT size="-1">Changes</FONT></A></LI>
    <LI><A href="./features.html"><FONT size="-1">Features/Status</FONT></A></LI>
    <LI><A href="./goals.html"><FONT size="-1">Goals</FONT></A></LI>
    <LI><A href="./todo.html"><FONT size="-1">Roadmap/Todo</FONT></A></LI>
    <LI><A href="./contributors.html"><FONT size="-1">Contributors</FONT></A></LI>
    <LI><A href="./contributing.html"><FONT size="-1">Contributing</FONT></A></LI>
    <LI><A href="./users.html"><FONT size="-1">Cactus Users</FONT></A></LI>
    <LI><A href="./testedon.html"><FONT size="-1">Tested on ...</FONT></A></LI>
    <LI><A href="./license.html"><FONT size="-1">License</FONT></A></LI>
  </FONT><BR>

  <BR><FONT color="#000000" size="+1">Downloads</FONT><BR><FONT size="-1">
    <LI><A href="./downloads.html"><FONT size="-1">Downloads</FONT></A></LI>
  </FONT><BR>

  <BR><FONT color="#000000" size="+1">Documentation</FONT><BR><FONT size="-1">
    <LI><A href="./how_it_works.html"><FONT size="-1">How it works ?</FONT></A></LI>
    
    <LI><A href="./getting_started.html"><FONT size="-1">Getting Started</FONT></A></LI>
    <LI><A href="./mockobjects.html"><FONT size="-1">Mock vs Container</FONT></A></LI>
    <LI><A href="./javadoc.html"><FONT size="-1">Javadocs</FONT></A></LI>
    
    
    <LI><A href="./faq.html"><FONT size="-1">FAQ</FONT></A></LI>
  </FONT><BR>

  <BR><FONT color="#000000" size="+1">Howto Guides</FONT><BR><FONT size="-1">
    <LI><A href="./howto_classpath.html"><FONT size="-1">Classpath Howto</FONT></A></LI>
    <LI><A href="./howto_config.html"><FONT size="-1">Config Howto</FONT></A></LI>
    <LI><A href="./howto_migration.html"><FONT size="-1">Migration Howto</FONT></A></LI>

    
    <LI><A href="./howto_testcase.html"><FONT size="-1">TestCase Howto</FONT></A></LI>
    
    
    

    <LI><A href="./howto_jsp.html"><FONT size="-1">Jsp Howto</FONT></A></LI>
    <LI><A href="./howto_runner.html"><FONT size="-1">Runner Howto</FONT></A></LI>
    <LI><A href="./howto_security.html"><FONT size="-1">Security Howto</FONT></A></LI>

    
    <LI><A href="./howto_ant.html"><FONT size="-1">Ant Howto</FONT></A></LI>
    
    
    

    <LI><A href="./howto_httpunit.html"><FONT size="-1">HttpUnit Howto</FONT></A></LI>
    <LI><A href="./howto_sample.html"><FONT size="-1">Sample Howto</FONT></A></LI>

    
    <LI><A href="./howto_ejb.html"><FONT size="-1">EJB Howto</FONT></A></LI>
    

    
    <LI><A href="./howto_ide.html"><FONT size="-1">IDE Howto</FONT></A></LI>
    
    
    
    

    <LI><A href="./howto_tomcat.html"><FONT size="-1">Tomcat Howto</FONT></A></LI>

    <LI><A href="./howto_junitee.html"><FONT size="-1">JUnitEE Howto</FONT></A></LI>
  </FONT><BR>

  <BR><FONT color="#000000" size="+1">Support</FONT><BR><FONT size="-1">
    <LI><FONT size="-1"><A href="http://jakarta.apache.org/site/bugs.html" target="">Bug database</A></FONT></LI>
    <LI><A href="./mailinglist.html"><FONT size="-1">Mailing list</FONT></A></LI>
  </FONT><BR>

  <BR><FONT color="#000000" size="+1">Misc.</FONT><BR><FONT size="-1">
    <LI><A href="./cactusname.html"><FONT size="-1">Why the name ?</FONT></A></LI>
    <LI><A href="./logos.html"><FONT size="-1">Logo Challenge</FONT></A></LI>
    <LI><A href="./resources.html"><FONT size="-1">Resources</FONT></A></LI>
    <LI><A href="./coverage.html"><FONT size="-1">Test Coverage</FONT></A></LI>
    
    
    
    <LI><FONT size="-1"><A href="http://jakarta.apache.org/cactus/stats/index.html" target="">Stats</A></FONT></LI>
    
  </FONT><BR>

  <BR><FONT color="#000000" size="+1">Developers</FONT><BR><FONT size="-1">
    <LI><FONT size="-1"><A href="http://jakarta.apache.org/site/cvsindex.html" target="">CVS</A></FONT></LI>
    <LI><A href="./coding_conventions.html"><FONT size="-1">Coding Conventions</FONT></A></LI>
    <LI><A href="./build_result.html"><FONT size="-1">Build results</FONT></A></LI>
    <LI><A href="./release_checklist.html"><FONT size="-1">Release Checklist</FONT></A></LI>
  </FONT><BR>

</FONT></TD><TD align="left" valign="top" width="*"><TABLE border="0" cellpadding="3" cellspacing="0"><TR><TD><BR>
  

  

    <DIV align="right"><TABLE border="0" cellpadding="2" cellspacing="0" width="100%"><TR><TD bgcolor="#525D76"><FONT color="#ffffff" face="arial,helvetica,sanserif" size="+1"><B>Introduction to testing secure code</B></FONT></TD></TR><TR><TD><FONT color="#000000" face="arial,helvetica,sanserif"><BR>

      <P align="justify">
        Beginning with version 1.3, Cactus is able to unit test Servlet code
        that uses the Servlet Security API (<CODE><FONT face="courier, monospaced">getRemoteUser()</FONT></CODE>,
        <CODE><FONT face="courier, monospaced">isUserInRole()</FONT></CODE>, <CODE><FONT face="courier, monospaced">getUserPrincipal()</FONT></CODE>).
      </P>
      <P align="justify">
        The way to perform this is by securing a Servlet Redirector defined
        in your <CODE><FONT face="courier, monospaced">web.xml</FONT></CODE> and then to specify user credentials
        in your <CODE><FONT face="courier, monospaced">beginXXX()</FONT></CODE>, as defined below.
      </P>

      <P><TABLE border="0" cellpadding="0" cellspacing="3" width="100%"><TR><TD valign="top" width="28"><IMG alt="Note" border="0" height="29" hspace="0" src="images/note.gif" vspace="0" width="28"></TD><TD valign="top"><FONT color="#000000" face="arial,helvetica,sanserif" size="-1"><I>
        The only currently supported authentication mechanism in Cactus 1.3 is
        the BASIC authentication.
      </I></FONT></TD></TR></TABLE></P>

      <P><TABLE border="0" cellpadding="0" cellspacing="3" width="100%"><TR><TD valign="top" width="28"><IMG alt="Note" border="0" height="29" hspace="0" src="images/note.gif" vspace="0" width="28"></TD><TD valign="top"><FONT color="#000000" face="arial,helvetica,sanserif" size="-1"><I>
        The Cactus sample application demonstrates how to unit test everything
        that is explained here.
      </I></FONT></TD></TR></TABLE></P>

    </FONT></TD></TR></TABLE></DIV><BR>

    <DIV align="right"><TABLE border="0" cellpadding="2" cellspacing="0" width="100%"><TR><TD bgcolor="#525D76"><FONT color="#ffffff" face="arial,helvetica,sanserif" size="+1"><B>Step 1 : Passing credentials in beginXXX()</B></FONT></TD></TR><TR><TD><FONT color="#000000" face="arial,helvetica,sanserif"><BR>

      <P align="justify">
        Let's start with an example :
      </P>

<DIV align="center"><TABLE border="1" cellpadding="2" cellspacing="2"><TR><TD><PRE>
public void beginBasicAuthentication(WebRequest theRequest)
{
    theRequest.setRedirectorName(&quot;ServletRedirectorSecure&quot;);
    theRequest.setAuthentication(
        new BasicAuthentication(&quot;testuser&quot;, &quot;testpassword&quot;));
}

public void testBasicAuthentication()
{
    assertEquals(&quot;testuser&quot;, request.getUserPrincipal().getName());
    assertEquals(&quot;testuser&quot;, request.getRemoteUser());
    assertTrue(&quot;User not in 'test' role&quot;, request.isUserInRole(&quot;test&quot;));
}
</PRE></TD></TR></TABLE></DIV>

      <P align="justify">
        There are several things to understand here :
      </P>
      <BLOCKQUOTE><UL>
        <LI>
          The Servlet that is called on the server side is the Cactus
          redirector servlet and thus we'll need to secure it in
          our <CODE><FONT face="courier, monospaced">web.xml</FONT></CODE> (see step 2 below).
        </LI>
        <LI>
          <CODE><FONT face="courier, monospaced">WebRequest.setRedirectorName()</FONT></CODE> is an API that lets you
          override the redirector defined in <CODE><FONT face="courier, monospaced">cactus.properties</FONT></CODE>.
          This is needed here because we want to test both code that is not
          secured (i.e. for which we don't want to have to pass credentials)
          and code that is secured and thus we need 2 redirectors. The
          <CODE><FONT face="courier, monospaced">ServletRedirectorSecure</FONT></CODE> redirector will be secured
          in step 2 below.
        </LI>
        <LI>
          <CODE><FONT face="courier, monospaced">WebRequest.setAuthentication()</FONT></CODE> is used to pass
          credentials to the server. It takes a parameter which is a
          <CODE><FONT face="courier, monospaced">BasicAuthentication</FONT></CODE> object (the only type of
          authentication currently supported by Cactus).
        </LI>
      </UL></BLOCKQUOTE>

    </FONT></TD></TR></TABLE></DIV><BR>

    <DIV align="right"><TABLE border="0" cellpadding="2" cellspacing="0" width="100%"><TR><TD bgcolor="#525D76"><FONT color="#ffffff" face="arial,helvetica,sanserif" size="+1"><B>Step 2 : Securing the Cactus Redirector</B></FONT></TD></TR><TR><TD><FONT color="#000000" face="arial,helvetica,sanserif"><BR>

      <P align="justify">
       All calls to the server side go through the Cactus Servlet Redirector
       and thus it is that servlet that needs to be secured in
       <CODE><FONT face="courier, monospaced">web.xml</FONT></CODE>. It is performed as follows (example) :
      </P>

<DIV align="center"><TABLE border="1" cellpadding="2" cellspacing="2"><TR><TD><PRE>
[...]

&lt;web-app&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;ServletRedirector&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.apache.cactus.server.ServletTestRedirector&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;ServletRedirectorSecure&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.apache.cactus.server.ServletTestRedirector&lt;/servlet-class&gt;
    &lt;/servlet&gt;

    [...]

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ServletRedirector&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/ServletRedirector&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ServletRedirectorSecure&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/ServletRedirectorSecure&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

    [...]

  	&lt;!-- Start Authentication --&gt;

  	&lt;security-constraint&gt;
     	&lt;web-resource-collection&gt;
        	&lt;web-resource-name&gt;SecurityRestriction&lt;/web-resource-name&gt;
         	&lt;description&gt;Protect the Cactus redirector servlet.&lt;/description&gt;
         	&lt;url-pattern&gt;/ServletRedirectorSecure&lt;/url-pattern&gt;
         	&lt;http-method&gt;GET&lt;/http-method&gt;
         	&lt;http-method&gt;POST&lt;/http-method&gt;
     	&lt;/web-resource-collection&gt;
     	&lt;auth-constraint&gt;
         	&lt;description&gt;Authorized Users Group&lt;/description&gt;
         	&lt;role-name&gt;test&lt;/role-name&gt;
     	&lt;/auth-constraint&gt;
     	&lt;user-data-constraint&gt;
        	&lt;transport-guarantee&gt;NONE&lt;/transport-guarantee&gt;
    	&lt;/user-data-constraint&gt;
   	&lt;/security-constraint&gt;

    &lt;login-config&gt;
    	&lt;auth-method&gt;BASIC&lt;/auth-method&gt;
   	&lt;/login-config&gt;

	&lt;security-role&gt;
		&lt;description&gt;Test role&lt;/description&gt;
		&lt;role-name&gt;test&lt;/role-name&gt;
	&lt;/security-role&gt;

  	&lt;!-- End Authentication --&gt;

&lt;/web-app&gt;
</PRE></TD></TR></TABLE></DIV>

    </FONT></TD></TR></TABLE></DIV><BR>

    <DIV align="right"><TABLE border="0" cellpadding="2" cellspacing="0" width="100%"><TR><TD bgcolor="#525D76"><FONT color="#ffffff" face="arial,helvetica,sanserif" size="+1"><B>Step 3 : Map Users/Roles</B></FONT></TD></TR><TR><TD><FONT color="#000000" face="arial,helvetica,sanserif"><BR>

      <P align="justify">
        This step consists in defining authorized users and mapping them to the
        role defined in <CODE><FONT face="courier, monospaced">web.xml</FONT></CODE> (e.g. in the example above, we have
        defined a <CODE><FONT face="courier, monospaced">test</FONT></CODE> role).
      </P>

      <P align="justify">
        This step is completely container-dependent and there is no standard
        way of doing it. You'll have to learn how to do it for your container.
        For example, here is how you would do it for Tomcat 4.0 :
      </P>
      <BLOCKQUOTE><UL>
        <LI>
          Create a <CODE><FONT face="courier, monospaced">tomcat-users.xml</FONT></CODE> file that you put in your
          Tomcat configuration directory (where you have
          <CODE><FONT face="courier, monospaced">server.xml</FONT></CODE> defined).
        </LI>
      </UL></BLOCKQUOTE>
      <P align="justify">
        Here is an example of <CODE><FONT face="courier, monospaced">tomcat-users.xml</FONT></CODE> that matches the
        test we have defined in step 1 :
      </P>

<DIV align="center"><TABLE border="1" cellpadding="2" cellspacing="2"><TR><TD><PRE>
&lt;tomcat-users&gt;
  &lt;user name=&quot;testuser&quot; password=&quot;testpassword&quot; roles=&quot;test&quot; /&gt;
&lt;/tomcat-users&gt;
</PRE></TD></TR></TABLE></DIV>

    </FONT></TD></TR></TABLE></DIV><BR>

  
</TD></TR></TABLE></TD></TR></TABLE><BR><TABLE border="0" cellpadding="0" cellspacing="0" width="100%"><TR><TD><HR noshade="" size="1"></TD></TR><TR><TD align="center"><FONT color="#525D76" face="arial,helvetica,sanserif" size="-1"><I>
                Copyright &copy; 2000-2002 The Apache Software Foundation.
                All Rights Reserved.
               </I></FONT></TD></TR></TABLE></BODY></HTML>